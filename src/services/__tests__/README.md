# IndexedDB 单元测试文档

本目录包含了对 IndexedDB 增删改查操作的完整单元测试套件。

## 测试文件结构

```
src/services/__tests__/
├── setup.js                 # 测试环境配置
├── storageService.test.js    # 存储服务测试
├── novelStorage.test.js      # 小说存储服务测试
├── db.test.js               # 数据库配置测试
└── README.md                # 本文档
```

## 测试覆盖范围

### StorageService 测试 (`storageService.test.js`)

#### CREATE 操作测试
- ✅ 创建新的键值对
- ✅ 处理不同数据类型（字符串、对象、数组）
- ✅ 处理复杂嵌套对象
- ✅ 处理特殊值（null, undefined, 0, false, 空字符串）
- ✅ 自动解析JSON字符串

#### READ 操作测试
- ✅ 读取存在的数据
- ✅ 不存在的键返回null
- ✅ JSON字符串向后兼容性处理
- ✅ 无效JSON字符串处理
- ✅ 大量数据读取性能

#### UPDATE 操作测试
- ✅ 更新现有数据
- ✅ 数据类型变更
- ✅ 并发更新操作

#### DELETE 操作测试
- ✅ 删除存在的数据
- ✅ 删除不存在的键
- ✅ 批量删除操作

#### CLEAR 操作测试
- ✅ 清空所有数据
- ✅ 空存储清空操作

#### 错误处理和边界情况
- ✅ 数据库操作失败处理
- ✅ 特殊字符键名处理
- ✅ 极长键名处理
- ✅ 数据一致性维护
- ✅ 大量并发操作
- ✅ 大型数据对象处理

### NovelStorage 测试 (`novelStorage.test.js`)

#### 小说CRUD操作
- ✅ 保存新小说
- ✅ 添加lastModified时间戳
- ✅ 保存失败处理
- ✅ 复杂小说数据结构
- ✅ 获取存在的小说
- ✅ 不存在小说返回null
- ✅ 获取错误处理

#### 小说列表操作
- ✅ 获取所有小说列表
- ✅ 空列表处理
- ✅ 保存小说列表
- ✅ 列表操作错误处理

#### 章节CRUD操作
- ✅ 保存新章节到现有小说
- ✅ 更新现有章节
- ✅ 小说不存在时错误处理
- ✅ 处理没有chapters数组的小说
- ✅ 章节保存错误处理

#### 自动保存功能
- ✅ 指定延迟后执行自动保存
- ✅ 防抖机制（取消之前的定时器）
- ✅ 默认防抖时间
- ✅ 自动保存错误处理

#### 集成测试
- ✅ 完整的小说创建和章节管理流程
- ✅ 并发章节保存操作

#### 错误处理和边界情况
- ✅ 无效小说ID处理
- ✅ 无效章节数据处理
- ✅ 存储服务不可用处理
- ✅ 大量章节的小说处理
- ✅ 数据一致性和验证
- ✅ 时间戳正确性

### Database 测试 (`db.test.js`)

#### 数据库配置
- ✅ 正确初始化数据库
- ✅ 定义正确的数据库模式
- ✅ key_value_store表存在
- ✅ 基本数据库操作方法

#### 数据库连接
- ✅ 打开数据库连接
- ✅ 关闭数据库连接
- ✅ 删除数据库

#### 错误处理
- ✅ 数据库打开失败
- ✅ 数据库关闭失败
- ✅ 数据库删除失败

## 运行测试

### 安装依赖
```bash
npm install
```

### 运行所有测试
```bash
npm run test
```

### 运行特定测试文件
```bash
# 存储服务测试
npm run test:storage

# 小说存储测试
npm run test:novel

# 数据库配置测试
npm run test:db
```

### 生成测试覆盖率报告
```bash
npm run test:coverage
```

### 监视模式运行测试
```bash
npm run test:watch
```

### 使用UI界面运行测试
```bash
npm run test:ui
```

## 测试覆盖率要求

项目设置了以下测试覆盖率阈值：
- 分支覆盖率：≥ 80%
- 函数覆盖率：≥ 80%
- 行覆盖率：≥ 80%
- 语句覆盖率：≥ 80%

## Mock 策略

### StorageService 测试
- 使用内存Map模拟IndexedDB存储
- Mock Dexie数据库操作
- 提供测试辅助方法清理存储

### NovelStorage 测试
- Mock storageService依赖
- 使用假定时器测试自动保存功能
- Mock console方法验证日志输出

### Database 测试
- Mock Dexie构造函数和方法
- 验证数据库配置和连接操作

## 测试数据

测试使用各种类型的模拟数据：
- 简单字符串和数字
- 复杂嵌套对象
- 大型数组数据
- 特殊值（null, undefined, 空字符串等）
- 无效数据（用于错误处理测试）

## 异常处理测试

每个测试套件都包含全面的异常处理测试：
- 网络错误模拟
- 存储空间不足
- 数据格式错误
- 并发操作冲突
- 系统资源限制

## 性能测试

包含基本的性能测试：
- 大量数据操作的时间限制
- 并发操作的处理能力
- 内存使用优化验证

## 持续集成

测试套件设计为在CI/CD环境中运行：
- 无需外部依赖
- 快速执行（通常<30秒）
- 详细的错误报告
- 覆盖率报告生成

## 维护指南

### 添加新测试
1. 在相应的测试文件中添加新的测试用例
2. 确保测试独立性（使用beforeEach清理）
3. 添加适当的断言和错误处理
4. 更新本文档

### 更新现有测试
1. 保持测试的向后兼容性
2. 更新相关的mock数据
3. 验证测试覆盖率不降低
4. 更新文档说明

### 调试测试
1. 使用`npm run test:ui`进行可视化调试
2. 检查console输出和错误堆栈
3. 验证mock配置正确性
4. 使用断点调试复杂逻辑